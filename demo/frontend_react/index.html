<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>GNN Sparsify Lab</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
      /* --- CLEAN THEME VARIABLES --- */
      :root {
        --bg-app: #f8fafc;
        --bg-panel: #ffffff;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --primary: #3b82f6;
        --primary-hover: #2563eb;
        --success: #10b981;
        --danger: #ef4444;
        --border: #e2e8f0;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: var(--bg-app);
        color: var(--text-primary);
        line-height: 1.5;
        padding-bottom: 4rem;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1.5rem;
      }

      /* Navbar */
      .navbar {
        background: var(--bg-panel);
        border-bottom: 1px solid var(--border);
        padding: 1rem 0;
        margin-bottom: 2rem;
      }
      .navbar-content {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .brand {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .brand-icon { color: var(--primary); font-size: 1.5rem; }

      /* Control Deck */
      .control-deck {
        background: var(--bg-panel);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 2rem;
        align-items: start;
        margin-bottom: 2rem;
        border: 1px solid var(--border);
      }

      .control-group h3 {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        margin-bottom: 1rem;
        font-weight: 600;
      }

      .input-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 0.4rem;
        color: var(--text-primary);
      }

      select, input[type="number"], input[type="text"] {
        width: 100%;
        padding: 0.6rem 0.8rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg-app);
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: 0.2s;
      }

      select:focus, input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .range-wrapper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      input[type="range"] {
        flex: 1;
        height: 6px;
        background: #cbd5e1;
        border-radius: 4px;
        appearance: none;
      }
      input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        background: var(--primary);
        border-radius: 50%;
        cursor: pointer;
      }

      /* Buttons */
      .actions-column {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        justify-content: flex-end;
        height: 100%;
        padding-top: 1.8rem;
        min-width: 180px;
      }

      button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        width: 100%;
      }

      .btn-primary { background-color: var(--primary); color: white; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); }
      .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
      .btn-secondary { background-color: white; border: 1px solid var(--border); color: var(--text-primary); }
      .btn-secondary:hover { background-color: #f1f5f9; }
      .btn-link { background: none; color: var(--text-secondary); font-size: 0.8rem; padding: 0.5rem; }
      .btn-link:hover { text-decoration: underline; color: var(--primary); }

      /* Dashboard Grid */
      .dashboard-grid {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 2rem;
      }

      .results-panel, .history-panel {
        background: var(--bg-panel);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 1.5rem;
        height: fit-content;
      }

      /* Metrics */
      .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border);
      }
      .metric-row:last-child { border-bottom: none; }
      
      .metric-info { display: flex; flex-direction: column; }
      .metric-title { font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }
      .metric-value { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
      
      .diff-pill {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 99px;
        display: inline-flex;
        align-items: center;
        gap: 2px;
      }
      .diff-positive { background: #dcfce7; color: #15803d; }
      .diff-negative { background: #fee2e2; color: #b91c1c; }
      .diff-neutral { background: #f1f5f9; color: #64748b; }

      .badge-success { background: #dcfce7; color: #166534; font-size: 0.75rem; padding: 2px 8px; border-radius: 6px; font-weight: 600; }
      .badge-neutral { background: #f1f5f9; color: #64748b; font-size: 0.75rem; padding: 2px 8px; border-radius: 6px; font-weight: 600; }
      
      /* Opt Box */
      .opt-box {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        font-size: 0.9rem;
        color: #1e40af;
        line-height: 1.6;
      }

      /* Table */
      .table-container { overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
      th { text-align: left; padding: 0.75rem 1rem; background: #f8fafc; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; border-bottom: 1px solid var(--border); }
      td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); color: var(--text-primary); vertical-align: middle; }
      tr:last-child td { border-bottom: none; }
      tr:hover td { background: #f8fafc; }

      .mono { font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.8rem; }

      .spinner { animation: spin 1s linear infinite; font-size: 1.1rem; }
      @keyframes spin { 100% { transform: rotate(360deg); } }

      /* Chart Panel */
      .chart-panel {
        background: var(--bg-panel);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 1.5rem;
        margin-top: 2rem;
      }

      .chart-panel h3 {
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .chart-panel p {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
      }

      .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
      }

      .chart-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 400px;
        color: var(--text-secondary);
        font-style: italic;
        font-size: 0.9rem;
      }

      @media (max-width: 1024px) {
        .control-deck { grid-template-columns: 1fr; }
        .dashboard-grid { grid-template-columns: 1fr; }
        .actions-column { flex-direction: row; padding-top: 0; }
        .actions-column button { width: auto; }
        .chart-container { height: 300px; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const API_URL = "http://localhost:8000";

      // SparsityChart Component
      function SparsityChart({ history, dataset, sparsifier }) {
        const chartRef = useRef(null);
        const chartInstanceRef = useRef(null);

        useEffect(() => {
          // Filter history to match current dataset and sparsifier
          const filtered = history.filter(
            (run) => run.dataset === dataset && run.sparsifier === sparsifier
          );

          // Need at least 2 points to draw a meaningful chart
          if (filtered.length < 2) {
            if (chartInstanceRef.current) {
              chartInstanceRef.current.destroy();
              chartInstanceRef.current = null;
            }
            return;
          }

          // Sort by sparsity ascending
          const sorted = [...filtered].sort(
            (a, b) => (a.sparsity_config || 0) - (b.sparsity_config || 0)
          );

          // Prepare data
          const sparsityValues = sorted.map((r) => r.sparsity_config || 0);
          const accuracyValues = sorted.map((r) => (r.accuracy || 0) * 100);
          const speedupValues = sorted.map((r) => (r.speedup || 0) * 100);

          // Destroy previous chart if it exists
          if (chartInstanceRef.current) {
            chartInstanceRef.current.destroy();
          }

          // Safety check for canvas ref
          if (!chartRef.current) {
            return;
          }

          // Create new chart
          const ctx = chartRef.current.getContext("2d");
          chartInstanceRef.current = new Chart(ctx, {
            type: "line",
            data: {
              labels: sparsityValues.map((v) => v.toFixed(2)),
              datasets: [
                {
                  label: "Accuracy (%)",
                  data: accuracyValues,
                  borderColor: "rgb(59, 130, 246)",
                  backgroundColor: "rgba(59, 130, 246, 0.1)",
                  tension: 0.4,
                  yAxisID: "y",
                },
                {
                  label: "Speedup (%)",
                  data: speedupValues,
                  borderColor: "rgb(16, 185, 129)",
                  backgroundColor: "rgba(16, 185, 129, 0.1)",
                  tension: 0.4,
                  yAxisID: "y",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: "index",
                intersect: false,
              },
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                    },
                  },
                },
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: "Sparsity (fraction of edges kept)",
                    font: {
                      size: 12,
                    },
                  },
                  ticks: {
                    font: {
                      size: 10,
                    },
                  },
                },
                y: {
                  title: {
                    display: true,
                    text: "Value (%)",
                    font: {
                      size: 12,
                    },
                  },
                  ticks: {
                    font: {
                      size: 10,
                    },
                  },
                },
              },
            },
          });

          // Cleanup function
          return () => {
            if (chartInstanceRef.current) {
              chartInstanceRef.current.destroy();
              chartInstanceRef.current = null;
            }
          };
        }, [history, dataset, sparsifier]);

        // Filter to check if we have enough data
        const filtered = history.filter(
          (run) => run.dataset === dataset && run.sparsifier === sparsifier
        );

        if (filtered.length < 2) {
          return (
            <div className="chart-empty">
              Run a few experiments first to see the chart.
            </div>
          );
        }

        return (
          <div className="chart-container">
            <canvas ref={chartRef}></canvas>
          </div>
        );
      }

      const DEFAULT_CONFIG = {
        dataset: "Cora",
        sparsifier: "random",
        sparsity: 0.5,
        epochs: 100,
        hiddenChannels: 16,
        dropout: 0.5,
        lr: 0.01,
        weightDecay: 0.0005,
        seed: 42,
        maxAccDropPercent: 2,
        targetSpeedupPercent: 30,
      };

      function App() {
        const [dataset, setDataset] = useState(DEFAULT_CONFIG.dataset);
        const [sparsifier, setSparsifier] = useState(DEFAULT_CONFIG.sparsifier);
        const [sparsity, setSparsity] = useState(DEFAULT_CONFIG.sparsity);
        const [epochs, setEpochs] = useState(DEFAULT_CONFIG.epochs);
        const [hiddenChannels, setHiddenChannels] = useState(DEFAULT_CONFIG.hiddenChannels);
        const [dropout, setDropout] = useState(DEFAULT_CONFIG.dropout);
        const [lr, setLr] = useState(DEFAULT_CONFIG.lr);
        const [weightDecay, setWeightDecay] = useState(DEFAULT_CONFIG.weightDecay);
        const [seed, setSeed] = useState(DEFAULT_CONFIG.seed);
        const [showAdvanced, setShowAdvanced] = useState(false);
        const [maxAccDropPercent, setMaxAccDropPercent] = useState(DEFAULT_CONFIG.maxAccDropPercent);
        const [targetSpeedupPercent, setTargetSpeedupPercent] = useState(DEFAULT_CONFIG.targetSpeedupPercent);

        const [sparsifiers, setSparsifiers] = useState([]);
        const [loadingSingle, setLoadingSingle] = useState(false);
        const [loadingOptimize, setLoadingOptimize] = useState(false);
        const [latestResult, setLatestResult] = useState(null);
        const [history, setHistory] = useState([]);
        const [error, setError] = useState(null);
        const [optSummary, setOptSummary] = useState(null);

        useEffect(() => {
          fetch(API_URL + "/sparsifiers")
            .then((res) => res.json())
            .then((raw) => {
              if (!Array.isArray(raw)) return;
              const mapped = (typeof raw[0] === "string") 
                ? raw.map(name => ({ name, label: name.charAt(0).toUpperCase() + name.slice(1) })) 
                : raw;
              setSparsifiers(mapped);
              if (!mapped.find(s => s.name === sparsifier)) setSparsifier(mapped[0].name);
            })
            .catch(() => {});
        }, []);

        const buildPayload = () => ({
          dataset, sparsifier, sparsity: Number(sparsity), epochs: Number(epochs),
          hidden_channels: Number(hiddenChannels), dropout: Number(dropout),
          lr: Number(lr), weight_decay: Number(weightDecay), seed: Number(seed)
        });

        const pushHistory = (metrics) => {
          setHistory(prev => [{
            id: Date.now() + Math.random(),
            timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
            ...metrics
          }, ...prev].slice(0, 50));
        };

        const handleRunSingle = async () => {
          setError(null); setOptSummary(null); setLoadingSingle(true);
          try {
            const res = await fetch(API_URL + "/run", {
              method: "POST", headers: { "Content-Type": "application/json" },
              body: JSON.stringify(buildPayload())
            });
            if (!res.ok) throw new Error("API Connection Error");
            const data = await res.json();
            setLatestResult(data);
            pushHistory(data);
          } catch (err) { setError(err.message); }
          finally { setLoadingSingle(false); }
        };

        const handleOptimize = async () => {
          setError(null); setOptSummary(null); setLoadingOptimize(true);
          try {
            const payload = {
              dataset, sparsifier, epochs, hidden_channels: hiddenChannels,
              dropout, lr, weight_decay: weightDecay, seed,
              sparsity_values: [1.0, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3],
              max_accuracy_drop: maxAccDropPercent / 100.0,
              target_speedup: targetSpeedupPercent / 100.0,
            };
            const res = await fetch(API_URL + "/optimize", {
              method: "POST", headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error("Optimization Failed");
            const data = await res.json();
            if(data.error) setError(data.error);
            if(data.runs) data.runs.forEach(r => pushHistory(r));
            
            if(data.recommended) setLatestResult(data.recommended);
            else if(data.baseline) setLatestResult(data.baseline);
            
            setOptSummary({
              baseline: data.baseline,
              recommended: data.recommended,
              constraints: data.constraints
            });
          } catch (err) { setError(err.message); }
          finally { setLoadingOptimize(false); }
        };

        const formatPct = (v) => v != null && !isNaN(v) ? (v * 100).toFixed(1) + "%" : "-";

        // --- HELPER: COMPARE CURRENT RUN VS LAST RUN ---
        const previousRun = history.length > 1 ? history[1] : null;

        const getDiff = (current, key, inverse = false) => {
          if (!previousRun || previousRun[key] == null || current[key] == null) return null;
          const diff = current[key] - previousRun[key];
          if (Math.abs(diff) < 0.0001) return <span className="diff-pill diff-neutral">-</span>;
          
          const isGood = inverse ? diff < 0 : diff > 0;
          const sign = diff > 0 ? "+" : "";
          const val = key === 'accuracy' ? (diff * 100).toFixed(1) + '%' : diff.toFixed(2);
          
          return (
            <span className={`diff-pill ${isGood ? 'diff-positive' : 'diff-negative'}`}>
              {sign}{val} vs last
            </span>
          );
        };

        // --- HELPER: CALCULATE SPEEDUP FOR TABLE ---
        // If backend speedup is null, we calculate "Improvement vs Previous Run"
        const renderSpeedupCell = (run, index) => {
          // 1. If Backend gives real speedup (e.g. from Auto Optimize vs Baseline)
          if (run.speedup != null) {
            return (
              <span className={run.speedup > 0 ? "badge-success" : "badge-neutral"}>
                {formatPct(run.speedup)} vs Base
              </span>
            );
          }

          // 2. Fallback: Compare with the row below (the previous run)
          const prev = history[index + 1];
          if (prev && prev.train_time_sec && run.train_time_sec) {
            // Speedup formula: (OldTime - NewTime) / OldTime
            const speedup = (prev.train_time_sec - run.train_time_sec) / prev.train_time_sec;
            const isFaster = speedup > 0;
            return (
              <span className={isFaster ? "badge-success" : "badge-neutral"} style={!isFaster ? {color:'#94a3b8'} : {}}>
                {isFaster ? "+" : ""}{formatPct(speedup)} vs Prev
              </span>
            );
          }

          return <span style={{color:'#cbd5e1'}}>-</span>;
        };

        return (
          <>
            <nav className="navbar">
              <div className="container navbar-content">
                <div className="brand">
                  <i className="ph ph-graph brand-icon"></i>
                  GNN Sparsify Lab
                </div>
              </div>
            </nav>

            <div className="container">
              
              {/* TOP CONTROLS */}
              <section className="control-deck">
                {/* Column 1 */}
                <div className="control-group">
                  <h3><i className="ph ph-database"></i> Setup</h3>
                  <div className="input-grid">
                    <div className="field">
                      <label>Dataset</label>
                      <select value={dataset} onChange={e => setDataset(e.target.value)}>
                        <option value="Cora">Cora</option>
                        <option value="Citeseer">Citeseer</option>
                        <option value="PubMed">PubMed</option>
                        <option value="ogbn-arxiv">ogbn-arxiv (Large)</option>
                        <option value="arxiv">arxiv (alias)</option>
                      </select>
                    </div>
                    <div className="field">
                      <label>Method</label>
                      <select value={sparsifier} onChange={e => setSparsifier(e.target.value)}>
                        {sparsifiers.map(s => (
                          <option key={s.name} value={s.name}>{s.label}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                  <div style={{marginTop: '1rem'}}>
                    <div className="field">
                      <label style={{display:'flex', justifyContent:'space-between'}}>
                        <span>Sparsity Ratio</span>
                        <span style={{color:'var(--primary)', fontWeight:'bold'}}>{sparsity}</span>
                      </label>
                      <div className="range-wrapper">
                        <span style={{fontSize: '0.8rem', color:'var(--text-secondary)'}}>Sparse</span>
                        <input 
                          type="range" min="0.1" max="1.0" step="0.1" 
                          value={sparsity} onChange={e => setSparsity(parseFloat(e.target.value))} 
                        />
                        <span style={{fontSize: '0.8rem', color:'var(--text-secondary)'}}>Full</span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Column 2 */}
                <div className="control-group">
                  <h3><i className="ph ph-sliders"></i> Hyperparameters</h3>
                  <div className="input-grid">
                    <div className="field">
                      <label>Epochs</label>
                      <input type="number" min="10" value={epochs} onChange={e => setEpochs(Number(e.target.value))} />
                    </div>
                    <div className="field">
                      <label>Optimization Goal (Speedup %)</label>
                      <input type="number" step="5" value={targetSpeedupPercent} onChange={e => setTargetSpeedupPercent(parseFloat(e.target.value))} />
                    </div>
                  </div>
                  
                  <div style={{marginTop:'1rem'}}>
                    <button className="btn-link" onClick={() => setShowAdvanced(!showAdvanced)}>
                      {showAdvanced ? "Hide Advanced Settings" : "Show Advanced Settings"}
                    </button>
                    
                    {showAdvanced && (
                      <div className="input-grid" style={{marginTop:'0.5rem'}}>
                        <div>
                          <label>Hidden Dim</label>
                          <input type="number" value={hiddenChannels} onChange={e => setHiddenChannels(Number(e.target.value))} />
                        </div>
                        <div>
                          <label>Dropout</label>
                          <input type="number" step="0.1" value={dropout} onChange={e => setDropout(parseFloat(e.target.value))} />
                        </div>
                        <div>
                          <label>Learning Rate</label>
                          <input type="number" step="0.001" value={lr} onChange={e => setLr(parseFloat(e.target.value))} />
                        </div>
                        <div>
                          <label>Seed</label>
                          <input type="number" value={seed} onChange={e => setSeed(Number(e.target.value))} />
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Column 3 */}
                <div className="actions-column">
                  <button className="btn-primary" onClick={handleRunSingle} disabled={loadingSingle || loadingOptimize}>
                    {loadingSingle ? <i className="ph ph-spinner spinner"></i> : <i className="ph ph-play"></i>}
                    Run Experiment
                  </button>
                  <button className="btn-secondary" onClick={handleOptimize} disabled={loadingSingle || loadingOptimize}>
                    {loadingOptimize ? <i className="ph ph-spinner spinner"></i> : <i className="ph ph-lightning"></i>}
                    Auto Optimize
                  </button>
                </div>
              </section>

              <div className="dashboard-grid">
                
                {/* LEFT: Latest Metrics */}
                <div className="results-panel">
                  <h3 style={{marginBottom:'1.5rem', display:'flex', alignItems:'center', gap:'0.5rem'}}>
                    <i className="ph ph-chart-bar" style={{color:'var(--primary)'}}></i>
                    Current Run
                  </h3>

                  {!latestResult && !loadingSingle && !loadingOptimize && (
                    <div style={{color: 'var(--text-secondary)', textAlign: 'center', padding: '2rem 0', fontStyle: 'italic'}}>
                      Waiting for data...
                    </div>
                  )}

                  {error && <div style={{background:'#fee2e2', color:'#b91c1c', padding:'1rem', borderRadius:'8px', fontSize:'0.9rem', marginBottom:'1rem'}}>{error}</div>}

                  {latestResult && (
                    <>
                      <div className="metric-row">
                        <div className="metric-info">
                          <span className="metric-title">Test Accuracy</span>
                          <div style={{display:'flex', alignItems:'center', gap:'8px'}}>
                            <span className="metric-value">{formatPct(latestResult.accuracy)}</span>
                            {getDiff(latestResult, 'accuracy')}
                          </div>
                        </div>
                        <i className="ph ph-target" style={{color:'var(--border)', fontSize:'1.5rem'}}></i>
                      </div>

                      <div className="metric-row">
                        <div className="metric-info">
                          <span className="metric-title">Duration</span>
                          <div style={{display:'flex', alignItems:'center', gap:'8px'}}>
                            <span className="metric-value" style={{color: 'var(--primary)'}}>
                              {latestResult.train_time_sec?.toFixed(2)}s
                            </span>
                            {getDiff(latestResult, 'train_time_sec', true)}
                          </div>
                        </div>
                        <i className="ph ph-timer" style={{color:'var(--border)', fontSize:'1.5rem'}}></i>
                      </div>

                      {/* Explicit Speedup Row for Current Run */}
                      <div className="metric-row">
                        <div className="metric-info">
                          <span className="metric-title">Speedup (Calculated)</span>
                          <div style={{display:'flex', alignItems:'center', gap:'8px'}}>
                            {/* If backend provides it, use it. If not, use diff */}
                            <span className="metric-value">
                              {latestResult.speedup != null ? formatPct(latestResult.speedup) : (
                                // Manual calculation for single run display
                                previousRun ? (
                                  formatPct((previousRun.train_time_sec - latestResult.train_time_sec) / previousRun.train_time_sec)
                                ) : "0.0%"
                              )}
                            </span>
                            <span style={{fontSize:'0.75rem', color:'var(--text-secondary)'}}>
                              {latestResult.speedup != null ? "vs Baseline" : "vs Last Run"}
                            </span>
                          </div>
                        </div>
                        <i className="ph ph-lightning" style={{color:'var(--border)', fontSize:'1.5rem'}}></i>
                      </div>

                      <div className="metric-row">
                        <div className="metric-info">
                          <span className="metric-title">Edges Kept</span>
                          <span className="metric-value">{formatPct(latestResult.sparsity_ratio)}</span>
                        </div>
                        <i className="ph ph-graph" style={{color:'var(--border)', fontSize:'1.5rem'}}></i>
                      </div>

                      {optSummary && optSummary.recommended && (
                        <div className="opt-box">
                          <strong><i className="ph ph-check-circle"></i> Optimization Success</strong><br/>
                          Found configuration: <strong>{formatPct(optSummary.recommended.speedup)} faster</strong> with {formatPct(optSummary.recommended.accuracy_drop)} accuracy drop.
                        </div>
                      )}
                    </>
                  )}
                </div>

                {/* RIGHT: History Table */}
                <div className="history-panel">
                  <h3 style={{marginBottom:'1.5rem', display:'flex', alignItems:'center', gap:'0.5rem'}}>
                    <i className="ph ph-clock-counter-clockwise"></i>
                    Session History
                  </h3>
                  
                  {history.length === 0 ? (
                    <p style={{color:'var(--text-secondary)', fontStyle:'italic', padding:'1rem'}}>
                      Runs will appear here. The table now automatically calculates speed differences.
                    </p>
                  ) : (
                    <div className="table-container">
                      <table>
                        <thead>
                          <tr>
                            <th>Dataset</th>
                            <th>Method</th>
                            <th>Sparsity</th>
                            <th>Accuracy</th>
                            <th>Duration</th>
                            <th>Speedup</th>
                            <th>Time</th>
                          </tr>
                        </thead>
                        <tbody>
                          {history.map((run, index) => (
                            <tr key={run.id}>
                              <td>{run.dataset}</td>
                              <td>{run.sparsifier}</td>
                              <td>{run.sparsity_config?.toFixed(2)}</td>
                              <td style={{fontWeight:'700'}}>{formatPct(run.accuracy)}</td>
                              <td className="mono">{run.train_time_sec?.toFixed(2)}s</td>
                              <td>{renderSpeedupCell(run, index)}</td>
                              <td style={{color:'var(--text-secondary)', fontSize:'0.8rem'}}>{run.timestamp}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>

              </div>

              {/* Charts Panel */}
              <section className="chart-panel">
                <h3>
                  <i className="ph ph-line-chart" style={{color:'var(--primary)'}}></i>
                  Sparsity vs Accuracy & Speedup
                </h3>
                <p>Visualising trade-offs across this session's runs</p>
                <SparsityChart history={history} dataset={dataset} sparsifier={sparsifier} />
              </section>
            </div>
          </>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>